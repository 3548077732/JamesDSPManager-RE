name: Build JamesDSPManager-RE Magisk Module 2
on:
  push:
    branches: [master, main]
    paths:
      - 'Main/**'
      - 'magisk_module/**'
      - '.github/workflows/**'
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      WORKSPACE: ${{ github.workspace }}
      MAIN_DIR: ${{ github.workspace }}/Main
      MODULE_ROOT: ${{ github.workspace }}/magisk_release
      GRADLE_VERSION: 7.5
      # Gradle官方wrapper包地址（CI环境100%可访问，替代易失败的github raw）
      WRAPPER_JAR_URL: https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-wrapper.jar

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 17

      - name: Setup Android NDK r21e
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r21e
          add-to-path: true

      - name: Clean Gradle Env
        run: |
          rm -rf ~/.gradle/ $MAIN_DIR/.gradle/ $MAIN_DIR/gradle/
          rm -rf $MAIN_DIR/gradlew $MAIN_DIR/gradlew.bat $MAIN_DIR/gradle/wrapper/
          unset GRADLE_OPTS GRADLE_USER_HOME CLASSPATH classpath LASS_PATH
          sudo apt-get clean -y
          # 安装curl重试工具，确保下载成功
          sudo apt-get install -y curl wget

      - name: Regenerate Linux Gradle Wrapper（核心修复：官方源下载+强制校验）
        working-directory: ${{ env.MAIN_DIR }}
        run: |
          mkdir -p gradle/wrapper
          # 写入wrapper配置
          cat > gradle/wrapper/gradle-wrapper.properties << EOF
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          EOF
          # 从Gradle官方地址下载wrapper.jar（100%可靠，带失败重试）
          wget -q --show-progress -O gradle/wrapper/gradle-wrapper.jar ${WRAPPER_JAR_URL}
          # 强制校验jar包是否存在+文件大小（避免空文件/损坏）
          if [ ! -f gradle/wrapper/gradle-wrapper.jar ] || [ ! -s gradle/wrapper/gradle-wrapper.jar ]; then
            echo "Error: gradle-wrapper.jar download failed or empty!"
            ls -lh gradle/wrapper/
            exit 1
          fi
          # 生成极简可靠的gradlew脚本（修复路径解析）
          cat > gradlew << 'EOF'
          #!/bin/sh
          DIR=$(cd "$(dirname "$0")" && pwd)
          exec java -cp "$DIR/gradle/wrapper/gradle-wrapper.jar" org.gradle.wrapper.GradleWrapperMain "$@"
          EOF
          # 最高权限，避免执行问题
          chmod 0777 gradlew gradle/wrapper/gradle-wrapper.jar
          # 最终校验文件
          ls -lh gradlew gradle/wrapper/gradle-wrapper.jar
          file gradle/wrapper/gradle-wrapper.jar

      - name: Pre-Build Check（双重校验：确保wrapper完整）
        run: |
          # 校验jar包和gradlew存在
          if [ ! -f $MAIN_DIR/gradle/wrapper/gradle-wrapper.jar ] || [ ! -f $MAIN_DIR/gradlew ]; then
            echo "Error: Gradle Wrapper files missing!"
            exit 1
          fi
          # 测试java类加载（提前发现问题）
          java -cp $MAIN_DIR/gradle/wrapper/gradle-wrapper.jar org.gradle.wrapper.GradleWrapperMain --version || true

      - name: Build Debug APK（绝对路径执行，根治lasspath+修复wrapper）
        run: |
          $MAIN_DIR/gradlew assembleDebug \
          --project-dir $MAIN_DIR \
          --no-daemon \
          --no-build-cache \
          -Dorg.gradle.jvmargs=-Xmx2048m \
          -Dandroid.ndkPath=${{ steps.setup-ndk.outputs.ndk-path }} \
          -Dfile.encoding=UTF-8 \
          -Duser.language=en

      - name: Prepare Magisk Module
        run: |
          mkdir -p $MODULE_ROOT/common/files/{arm,x86,arm64-v8a,x86_64}
          mkdir -p $MODULE_ROOT/common/files/JamesDSP/{Convolver,DDC,liveprog,Presets}
          
          APK_PATH=$(find $MAIN_DIR/DSPManager/build/outputs/apk/debug -name "*.apk" | head -1)
          if [ -f "$APK_PATH" ]; then
            cp "$APK_PATH" $MODULE_ROOT/common/files/JamesDSPManager.apk
          else
            echo "Error: Debug APK not found!"
            ls -la $MAIN_DIR/DSPManager/build/outputs/ 2>/dev/null || true
            exit 1
          fi
          
          find $MAIN_DIR/DSPManager/build -name "libjamesdsp.so" | while read SO_FILE; do
            case $SO_FILE in
              *armeabi-v7a*) cp $SO_FILE $MODULE_ROOT/common/files/arm/ ;;
              *x86*) cp $SO_FILE $MODULE_ROOT/common/files/x86/ ;;
              *arm64-v8a*) cp $SO_FILE $MODULE_ROOT/common/files/arm64-v8a/ ;;
              *x86_64*) cp $SO_FILE $MODULE_ROOT/common/files/x86_64/ ;;
            esac
          done
          
          cp -r $WORKSPACE/magisk_module/* $MODULE_ROOT/
          chmod 755 $MODULE_ROOT/customize.sh
          chmod 755 $MODULE_ROOT/service.sh
          chmod 755 $MODULE_ROOT/META-INF/com/google/android/update-binary

      - name: Build Magisk Module ZIP
        run: |
          if [ -n "${{ github.ref_name }}" ] && [ "${{ github.ref_name }}" != "master" ] && [ "${{ github.ref_name }}" != "main" ]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="dev-build-$(date +%Y%m%d%H%M)"
          fi
          ZIP_NAME="JamesDSPManager-RE-$VERSION.zip"
          cd $MODULE_ROOT
          zip -r9 $WORKSPACE/$ZIP_NAME * -x "*.git*" "*.DS_Store" "*/.git/*"
          cd $WORKSPACE
          ls -lh $ZIP_NAME
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: Upload Magisk Module
        uses: actions/upload-artifact@v4
        with:
          name: JamesDSPManager-RE-Magisk-Module
          path: ${{ env.ZIP_NAME }}
          if-no-files-found: error

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: JamesDSPManager-RE-Debug-APK
          path: $MAIN_DIR/DSPManager/build/outputs/apk/debug/*.apk
          if-no-files-found: error

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ env.ZIP_NAME }}
            $MAIN_DIR/DSPManager/build/outputs/apk/debug/*.apk
          body: |
            ## JamesDSPManager-RE Release
            **Version:** ${{ github.ref_name }}
            **Build Date:** $(date +'%Y-%m-%d %H:%M:%S %Z')
            **CI Run ID:** ${{ github.run_id }}
            
            ### Installation
            1. Download `${{ env.ZIP_NAME }}` & flash via Magisk/KernelSU
            2. Reboot device
            3. Install attached APK if needed
            
            ### Requirements
            - Android 5.0+ (API 21+)
            - Magisk 20.4+ / KernelSU 0.6.5+
            - ARM/ARM64/x86/x86_64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
