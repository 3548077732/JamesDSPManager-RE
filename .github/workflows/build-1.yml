name: Build JamesDSPManager-RE Magisk Module

on:
  push:
    branches: [ master, main ]
    paths:
      - 'Main/**'
      - 'magisk_module/**'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      MODULE_ROOT: ${{ github.workspace }}/magisk_release
      MAIN_DIR: ${{ github.workspace }}/Main

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        cache: gradle

    - name: Setup Android NDK r21e
      id: setup-ndk
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r21e
        add-to-path: true

    - name: 导出NDK路径到环境变量
      run: echo "ANDROID_NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV

    - name: Get Build Date
      id: date
      run: echo "date=$(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_OUTPUT

    - name: 检查Main目录核心配置文件
      run: |
        if [ ! -f $MAIN_DIR/settings.gradle ] && [ ! -f $MAIN_DIR/settings.gradle.kts ]; then
          echo "Error: settings.gradle not found in Main directory!"
          ls -la $MAIN_DIR
          exit 1
        fi
        if [ ! -f $MAIN_DIR/gradlew ]; then
          echo "Error: gradlew not found in Main directory!"
          exit 1
        fi

    - name: 修复gradlew并赋予执行权限
      run: |
        sudo apt-get update && sudo apt-get install -y dos2unix
        dos2unix $MAIN_DIR/gradlew
        chmod +x $MAIN_DIR/gradlew

    - name: Build Debug APK with Gradle（移除重复的settings-file参数，核心修复本次报错）
      working-directory: ${{ env.MAIN_DIR }}
      run: |
        ./gradlew assembleDebug --no-daemon \
        -Dorg.gradle.jvmargs=-Xmx2048m \
        -Dandroid.ndkPath=${{ env.ANDROID_NDK_HOME }}

    - name: Prepare Magisk Module Structure
      run: |
        mkdir -p $MODULE_ROOT/common/files/{arm,x86,arm64-v8a,x86_64}
        mkdir -p $MODULE_ROOT/common/files/JamesDSP/{Convolver,DDC,liveprog,Presets}
        
        APK_PATH=$(find $MAIN_DIR/DSPManager/build/outputs/apk/debug -name "*.apk" | head -1)
        if [ -f "$APK_PATH" ]; then
          cp "$APK_PATH" $MODULE_ROOT/common/files/JamesDSPManager.apk
        else
          echo "Error: Debug APK not found!"
          ls -la $MAIN_DIR/DSPManager/build/outputs/apk/ 2>/dev/null || true
          exit 1
        fi
        
        find $MAIN_DIR/DSPManager/build/intermediates -name "libjamesdsp.so" | while read SO_FILE; do
          case $SO_FILE in
            *armeabi-v7a*) cp $SO_FILE $MODULE_ROOT/common/files/arm/ ;;
            *x86*) cp $SO_FILE $MODULE_ROOT/common/files/x86/ ;;
            *arm64-v8a*) cp $SO_FILE $MODULE_ROOT/common/files/arm64-v8a/ ;;
            *x86_64*) cp $SO_FILE $MODULE_ROOT/common/files/x86_64/ ;;
          esac
        done
        
        cp -r magisk_module/* $MODULE_ROOT/
        chmod 755 $MODULE_ROOT/{customize.sh,service.sh}
        chmod 755 $MODULE_ROOT/META-INF/com/google/android/update-binary

    - name: Create Magisk Module ZIP
      run: |
        if [ -n "${{ github.ref_name }}" ]; then
          VERSION="${{ github.ref_name }}"
        else
          VERSION="dev-build-$(date +%Y%m%d%H%M)"
        fi
        ZIP_NAME="JamesDSPManager-RE-$VERSION.zip"
        cd $MODULE_ROOT
        zip -r9 ${{ github.workspace }}/$ZIP_NAME * -x "*.git*" "*.DS_Store" "*/.git/*"
        cd ${{ github.workspace }}
        ls -lh $ZIP_NAME
        echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

    - name: Upload Magisk Module
      uses: actions/upload-artifact@v4
      with:
        name: JamesDSPManager-RE-Magisk-Module
        path: ${{ env.ZIP_NAME }}
        if-no-files-found: error

    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: JamesDSPManager-RE-Debug-APK
        path: ${{ env.MAIN_DIR }}/DSPManager/build/outputs/apk/debug/*.apk
        if-no-files-found: error

    - name: Create GitHub Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ env.ZIP_NAME }}
          ${{ env.MAIN_DIR }}/DSPManager/build/outputs/apk/debug/*.apk
        body: |
          ## JamesDSPManager-RE Release
          
          **Version:** ${{ github.ref_name }}
          **Build Date:** ${{ steps.date.outputs.date }}
          **CI Run ID:** ${{ github.run_id }}
          
          ### Installation
          1. Download `${{ env.ZIP_NAME }}` and flash via Magisk/KernelSU
          2. Reboot device
          3. Install the attached APK if needed
          
          ### Requirements
          - Android 5.0+ (API 21+)
          - Magisk 20.4+ / KernelSU 0.6.5+
          - ARM/ARM64/x86/x86_64
          
          ### What's Changed
          ${{ github.event.head_commit.message || 'No commit message provided' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
