name: Build JamesDSPManager-RE Magisk Module 2

on:
  push:
    branches: [ master, main ]
    paths:
      - 'Main/**'
      - 'magisk_module/**'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # 全局绝对路径，全程无相对路径/CD切换
      WORKSPACE: ${{ github.workspace }}
      MAIN_DIR: ${{ github.workspace }}/Main
      MODULE_ROOT: ${{ github.workspace }}/magisk_release
      GRADLE_VERSION: 7.5  # 与项目指定版本一致

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        cache: none  # 禁用默认缓存，避免残留错误

    - name: Setup Android NDK r21e
      id: setup-ndk
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r21e
        add-to-path: true

    - name: 清理所有Gradle缓存+环境变量（核心：清除残留错误配置）
      run: |
        # 清理全局/项目gradle缓存
        rm -rf ~/.gradle/ $MAIN_DIR/.gradle/ $MAIN_DIR/gradle/
        # 清理项目自带的污染gradlew文件
        rm -rf $MAIN_DIR/gradlew $MAIN_DIR/gradlew.bat $MAIN_DIR/gradle/wrapper/
        # 禁用所有可能干扰的环境变量
        unset GRADLE_OPTS GRADLE_USER_HOME CLASSPATH classpath LASS_PATH

    - name: 重新生成纯Linux格式Gradle Wrapper（彻底替换污染文件）
      working-directory: ${{ env.MAIN_DIR }}
      run: |
        # 手动生成gradle wrapper配置
        mkdir -p gradle/wrapper
        # 写入纯Linux格式wrapper配置，无任何隐藏字符
        cat > gradle/wrapper/gradle-wrapper.properties << EOF
        distributionBase=GRADLE_USER_HOME
        distributionPath=wrapper/dists
        distributionUrl=https\://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip
        zipStoreBase=GRADLE_USER_HOME
        zipStorePath=wrapper/dists
        EOF
        # 生成Linux原生gradlew（无CRLF/乱码）
        curl -sL https://raw.githubusercontent.com/gradle/gradle/v${GRADLE_VERSION}/gradle-wrapper/gradle-wrapper.jar > gradle/wrapper/gradle-wrapper.jar
        cat > gradlew << 'EOF'
        #!/usr/bin/env sh
        APP_BASE_NAME=$(basename "$0")
        APP_HOME=$(cd "$(dirname "$0")" && pwd -P)
        exec java -cp "$APP_HOME/gradle/wrapper/gradle-wrapper.jar" org.gradle.wrapper.GradleWrapperMain "$@"
        EOF
        # 赋予最高执行权限
        chmod 775 gradlew
        # 验证文件格式（无CRLF）
        file gradlew

    - name: Build Debug APK（绝对路径执行+极简参数，无任何解析歧义）
      run: |
        # 用绝对路径执行，放弃所有working-directory/CD，彻底规避shell解析问题
        $MAIN_DIR/gradlew assembleDebug \
        --project-dir $MAIN_DIR \
        --no-daemon \
        --no-build-cache \
        -Dorg.gradle.jvmargs=-Xmx2048m \
        -Dandroid.ndkPath=${{ steps.setup-ndk.outputs.ndk-path }} \
        -Dfile.encoding=UTF-8 \
        -Duser.language=en

    - name: Prepare Magisk Module Structure
      run: |
        mkdir -p $MODULE_ROOT/common/files/{arm,x86,arm64-v8a,x86_64}
        mkdir -p $MODULE_ROOT/common/files/JamesDSP/{Convolver,DDC,liveprog,Presets}
        
        # 绝对路径查找APK/SO库
        APK_PATH=$(find $MAIN_DIR/DSPManager/build/outputs/apk/debug -name "*.apk" | head -1)
        if [ -f "$APK_PATH" ]; then
          cp "$APK_PATH" $MODULE_ROOT/common/files/JamesDSPManager.apk
        else
          echo "Error: Debug APK not found!"
          ls -la $MAIN_DIR/DSPManager/build/outputs/ 2>/dev/null || true
          exit 1
        fi
        
        find $MAIN_DIR/DSPManager/build -name "libjamesdsp.so" | while read SO_FILE; do
          case $SO_FILE in
            *armeabi-v7a*) cp $SO_FILE $MODULE_ROOT/common/files/arm/ ;;
            *x86*) cp $SO_FILE $MODULE_ROOT/common/files/x86/ ;;
            *arm64-v8a*) cp $SO_FILE $MODULE_ROOT/common/files/arm64-v8a/ ;;
            *x86_64*) cp $SO_FILE $MODULE_ROOT/common/files/x86_64/ ;;
          esac
        done
        
        cp -r $WORKSPACE/magisk_module/* $MODULE_ROOT/
        chmod 755 $MODULE_ROOT/{customize.sh,service.sh}
        chmod 755 $MODULE_ROOT/META-INF/com/google/android/update-binary

    - name: Create Magisk Module ZIP
      run: |
        VERSION=${{ github.ref_name || 'dev-build-'$(date +%Y%m%d%H%M) }}
        ZIP_NAME="JamesDSPManager-RE-$VERSION.zip"
        cd $MODULE_ROOT
        zip -r9 $WORKSPACE/$ZIP_NAME * -x "*.git*" "*.DS_Store" "*/.git/*"
        cd $WORKSPACE
        ls -lh $ZIP_NAME
        echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

    - name: Upload Magisk Module
      uses: actions/upload-artifact@v4
      with:
        name: JamesDSPManager-RE-Magisk-Module
        path: ${{ env.ZIP_NAME }}
        if-no-files-found: error

    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: JamesDSPManager-RE-Debug-APK
        path: $MAIN_DIR/DSPManager/build/outputs/apk/debug/*.apk
        if-no-files-found: error

    - name: Create GitHub Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ env.ZIP_NAME }}
          $MAIN_DIR/DSPManager/build/outputs/apk/debug/*.apk
        body: |
          ## JamesDSPManager-RE Release
          **Version:** ${{ github.ref_name }}
          **Build Date:** $(date +'%Y-%m-%d %H:%M:%S %Z')
          **CI Run ID:** ${{ github.run_id }}
          
          ### Installation
          1. Download `${{ env.ZIP_NAME }}` & flash via Magisk/KernelSU
          2. Reboot device
          3. Install attached APK if needed
          
          ### Requirements
          - Android 5.0+ (API 21+)
          - Magisk 20.4+ / KernelSU 0.6.5+
          - ARM/ARM64/x86/x86_64
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
